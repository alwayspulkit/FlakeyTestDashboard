<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Flaky Test Analysis Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .header h1 {
            color: #2d3748;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 14px;
        }

        .upload-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #718096;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-card .value {
            color: #2d3748;
            font-size: 32px;
            font-weight: bold;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #2d3748;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .group-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .group-item:hover {
            background: #edf2f7;
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .group-item::after {
            content: '‚ñº';
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 12px;
            color: #667eea;
            transition: transform 0.3s;
        }

        .group-item.expanded::after {
            transform: rotate(180deg);
        }

        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .group-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .group-count {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .group-description {
            color: #718096;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .group-tests {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            animation: slideDown 0.3s ease;
        }

        .group-tests.expanded {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .test-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .test-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
            transform: translateX(4px);
        }

        .test-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .test-name::after {
            content: '‚Üí';
            color: #667eea;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
        }

        .test-item:hover .test-name::after {
            opacity: 1;
            transform: translateX(4px);
        }

        .test-meta {
            color: #718096;
            font-size: 11px;
        }

        .platform-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-right: 6px;
        }

        .platform-android {
            background: #c6f6d5;
            color: #22543d;
        }

        .platform-ios {
            background: #bee3f8;
            color: #2c5282;
        }

        .platform-web {
            background: #feebc8;
            color: #7c2d12;
        }

        .insight-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid #667eea;
        }

        .insight-title {
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .insight-text {
            color: #718096;
            font-size: 13px;
            line-height: 1.6;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            min-width: 150px;
        }

        .search-container {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px 12px 40px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-wrapper {
            position: relative;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
        }

        .date-range-selector {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
            background: #f7fafc;
            padding: 4px;
            border-radius: 6px;
        }

        .view-toggle-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            color: #718096;
            font-weight: 600;
        }

        .view-toggle-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #f7fafc;
            border-color: #667eea;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .test-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .test-detail-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            color: #2d3748;
            font-size: 20px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f7fafc;
            color: #2d3748;
        }

        .modal-body {
            padding: 24px;
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-label {
            font-weight: 600;
            color: #718096;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .detail-value {
            color: #2d3748;
            font-size: 14px;
            line-height: 1.6;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            margin-top: 4px;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
        }

        .search-results.active {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #f7fafc;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-highlight {
            background: #fef3c7;
            padding: 2px 4px;
            border-radius: 2px;
        }

        .date-group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scroll-to-top {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s;
            z-index: 999;
        }

        .scroll-to-top.visible {
            display: flex;
        }

        .scroll-to-top:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .toast {
            position: fixed;
            bottom: 80px;
            right: 30px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            animation: slideInUp 0.3s ease;
        }

        .toast.visible {
            display: flex;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .group-count-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .expand-hint {
            color: #667eea;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .severity-critical {
            border-left-color: #f56565;
        }

        .severity-high {
            border-left-color: #ed8936;
        }

        .severity-medium {
            border-left-color: #ecc94b;
        }

        .action-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
        }

        .action-btn:hover {
            background: #38a169;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .root-cause-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .trend-analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .root-cause-grid,
            .trend-analysis-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI-Powered Flaky Test Analysis Dashboard</h1>
            <p>Upload your test failure data to automatically group, analyze, and get actionable insights</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls">
                <div>
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#cbd5e0" stroke-width="2" style="margin: 0 auto 16px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="17 8 12 3 7 8"></polyline>
                        <line x1="12" y1="3" x2="12" y2="15"></line>
                    </svg>
                    <h3 style="color: #2d3748; margin-bottom: 8px;">Drop your test data here or click to upload</h3>
                    <p style="color: #718096; font-size: 14px;">Supports CSV and Excel files</p>
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 16px;">
                        <button class="btn" onclick="document.getElementById('fileInput').click(); console.log('Button clicked, opening file dialog...');">
                            üìÇ Choose File
                        </button>
                        <button class="btn" style="background: #48bb78;" onclick="showPasteArea(); console.log('Show paste area clicked');">
                            üìã Paste CSV Data
                        </button>
                        
                    </div>
                    <div style="margin-top: 16px; font-size: 11px; color: #a0aec0;">
                        <div id="uploadStatus">Waiting for file...</div>
                    </div>
                </div>
            </div>
            
            <!-- Paste Area (hidden by default) -->
            <div id="pasteArea" style="display: none; margin-top: 20px;">
                <div style="background: #f7fafc; border: 2px dashed #cbd5e0; border-radius: 8px; padding: 20px;">
                    <h3 style="color: #2d3748; margin-bottom: 12px;">üìã Paste Your CSV Data</h3>
                    <p style="color: #718096; font-size: 14px; margin-bottom: 12px;">
                        Open your CSV in Excel or text editor, select all (Ctrl+A), copy (Ctrl+C), then paste below:
                    </p>
                    <textarea 
                        id="csvPasteBox" 
                        placeholder="Paste your CSV data here...
Example:
Date,Platform,Test Case,failure_description,Test Owner
Nov 7 2025,iOS,testLogin,Login timeout,AUTH_TEAM
Nov 7 2025,ANDROID,testMenu,Menu error,VENDOR_DISCOVERY"
                        style="width: 100%; min-height: 200px; padding: 12px; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #cbd5e0; border-radius: 6px; resize: vertical;"
                    ></textarea>
                    <div style="display: flex; gap: 12px; margin-top: 12px;">
                        <button class="btn" style="background: #667eea;" onclick="processPastedData()">
                            ‚úÖ Process Data
                        </button>
                        <button class="btn" style="background: #a0aec0;" onclick="hidePasteArea()">
                            ‚úñ Cancel
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="fileName" style="margin-top: 16px; color: #2d3748; font-weight: 600;"></div>
        </div>

        <div id="dashboard" style="display: none;">
            <div class="search-container">
                <div class="search-wrapper">
                    <span class="search-icon">üîç</span>
                    <input 
                        type="text" 
                        class="search-box" 
                        id="searchBox" 
                        placeholder="Search by test ID, test name, or failure description..."
                        autocomplete="off"
                    >
                    <div class="search-results" id="searchResults"></div>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h2>üìÖ Date Range Selection</h2>
                <div class="date-range-selector">
                    <label style="color: #718096; font-size: 14px; font-weight: 600;">From:</label>
                    <input type="date" class="date-input" id="dateFrom">
                    <label style="color: #718096; font-size: 14px; font-weight: 600;">To:</label>
                    <input type="date" class="date-input" id="dateTo">
                    <button class="btn" onclick="applyDateRange()" style="padding: 10px 20px;">Apply</button>
                    <button class="btn" onclick="clearDateRange()" style="padding: 10px 20px; background: #718096;">Clear</button>
                    
                    <div class="view-toggle" style="margin-left: auto;">
                        <button class="view-toggle-btn active" id="combinedViewBtn" onclick="setView('combined')">
                            üìä Combined View
                        </button>
                        <button class="view-toggle-btn" id="dailyViewBtn" onclick="setView('daily')">
                            üìÜ Daily View
                        </button>
                        <button class="view-toggle-btn" id="platformViewBtn" onclick="setView('platform')">
                            üì± Platform View
                        </button>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Failures</h3>
                    <div class="value" id="totalFailures">0</div>
                </div>
                <div class="stat-card">
                    <h3>AI Groups Found</h3>
                    <div class="value" id="totalGroups">0</div>
                </div>
                <div class="stat-card">
                    <h3>Platforms</h3>
                    <div class="value" id="totalPlatforms">0</div>
                </div>
                <div class="stat-card">
                    <h3>Teams Affected</h3>
                    <div class="value" id="totalTeams">0</div>
                </div>
                <div class="stat-card">
                    <h3>Date Range</h3>
                    <div class="value" id="dateRangeStat" style="font-size: 16px;">All</div>
                </div>
            </div>

            <div class="filters">
                <select class="filter-select" id="platformFilter">
                    <option value="all">All Platforms</option>
                </select>
                <select class="filter-select" id="teamFilter">
                    <option value="all">All Teams</option>
                </select>
                <select class="filter-select" id="severityFilter">
                    <option value="all">All Severities</option>
                    <option value="critical">Critical</option>
                    <option value="high">High</option>
                    <option value="medium">Medium</option>
                </select>
            </div>

            <div class="dashboard-grid">
                <div class="card">
                    <h2>
                        üéØ AI-Grouped Failures
                        <span class="ai-badge">AI POWERED</span>
                    </h2>
                    <div id="groupedFailures"></div>
                </div>

                <div class="card">
                    <h2>
                        üí° Smart Insights
                        <span class="ai-badge">AI POWERED</span>
                    </h2>
                    <div id="insights"></div>
                </div>

                <div class="card full-width" id="rootCauseSection" style="display: none;">
                    <h2>
                        üî¨ Root Cause Analysis
                        <span class="ai-badge">AI POWERED</span>
                    </h2>
                    <div id="rootCauseAnalysis"></div>
                </div>

                <div class="card">
                    <h2>üìä Failure Trends</h2>
                    <div class="chart-container" id="trendChart"></div>
                </div>

                <div class="card">
                    <h2>üè¢ Team Distribution</h2>
                    <div class="chart-container" id="teamChart"></div>
                </div>

                <div class="card full-width">
                    <h2>üìà Trend Analysis</h2>
                    <div id="trendAnalysis"></div>
                </div>
            </div>
        </div>

        <!-- Test Detail Modal -->
        <div class="test-detail-modal" id="testDetailModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Test Failure Details</h2>
                    <button class="modal-close" onclick="closeTestDetail()">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Scroll to Top Button -->
        <button class="scroll-to-top" id="scrollToTop" onclick="scrollToTop()">‚Üë</button>

        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <span id="toastMessage"></span>
        </div>
    </div>

    <script>
        let testData = [];
        let filteredData = [];
        let currentView = 'combined'; // 'combined' or 'daily'
        let selectedDateRange = { from: null, to: null };
        let currentPage = 1;
        let itemsPerPage = 50;
        let searchTimeout = null;

        // Define handleFile FIRST before any initialization code
        function handleFile(file) {
            if (!file) {
                console.log('handleFile called but no file provided');
                return;
            }
            
            console.log('=== HANDLE FILE CALLED ===');
            console.log('File selected:', file.name, file.type, file.size);
            
            const statusDiv = document.getElementById('uploadStatus');
            if (statusDiv) {
                statusDiv.textContent = 'Reading file...';
                statusDiv.style.color = '#667eea';
            }
            
            document.getElementById('fileName').innerHTML = `
                <div class="spinner"></div>
                <div style="margin-top: 12px;">Processing ${file.name}...</div>
            `;
            
            const reader = new FileReader();
            
            reader.onerror = (error) => {
                console.error('File reading error:', error);
                document.getElementById('fileName').innerHTML = `
                    <div style="color: #f56565;">‚ùå Error reading file. Please try again.</div>
                `;
                if (statusDiv) {
                    statusDiv.textContent = 'Error reading file!';
                    statusDiv.style.color = '#f56565';
                }
            };
            
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    console.log('File content loaded, length:', content.length);
                    console.log('First 200 chars:', content.substring(0, 200));
                    
                    document.getElementById('fileName').innerHTML = `
                        <div style="color: #48bb78;">‚úÖ ${file.name} uploaded successfully!</div>
                    `;
                    
                    if (statusDiv) {
                        statusDiv.textContent = 'File loaded! Parsing...';
                        statusDiv.style.color = '#48bb78';
                    }
                    
                    parseCSV(content);
                } catch (error) {
                    console.error('Processing error:', error);
                    document.getElementById('fileName').innerHTML = `
                        <div style="color: #f56565;">‚ùå Error processing file: ${error.message}</div>
                    `;
                    if (statusDiv) {
                        statusDiv.textContent = 'Error processing file!';
                        statusDiv.style.color = '#f56565';
                    }
                }
            };
            
            console.log('Starting to read file as text...');
            reader.readAsText(file);
        }

        // Show paste area - make it globally accessible
        window.showPasteArea = function() {
            console.log('=== SHOWING PASTE AREA ===');
            const uploadArea = document.getElementById('uploadArea');
            const pasteArea = document.getElementById('pasteArea');
            
            if (!uploadArea || !pasteArea) {
                console.error('Upload area or paste area not found!');
                alert('Error: Could not find required elements. Please refresh the page.');
                return;
            }
            
            uploadArea.style.display = 'none';
            pasteArea.style.display = 'block';
            
            const pasteBox = document.getElementById('csvPasteBox');
            if (pasteBox) {
                pasteBox.focus();
            }
            
            console.log('Paste area is now visible');
        };

        // Hide paste area - make it globally accessible
        window.hidePasteArea = function() {
            console.log('=== HIDING PASTE AREA ===');
            const uploadArea = document.getElementById('uploadArea');
            const pasteArea = document.getElementById('pasteArea');
            const pasteBox = document.getElementById('csvPasteBox');
            
            if (pasteArea) pasteArea.style.display = 'none';
            if (uploadArea) uploadArea.style.display = 'block';
            if (pasteBox) pasteBox.value = '';
            
            console.log('Paste area is now hidden');
        };

        // Process pasted CSV data - make it globally accessible
        window.processPastedData = function() {
            console.log('=== PROCESSING PASTED DATA ===');
            
            const textarea = document.getElementById('csvPasteBox');
            if (!textarea) {
                console.error('Paste box not found!');
                alert('Error: Could not find paste box. Please refresh the page.');
                return;
            }
            
            const content = textarea.value.trim();
            
            console.log('Pasted content length:', content.length);
            console.log('First 200 chars:', content.substring(0, 200));
            
            if (!content) {
                alert('Please paste some CSV data first!');
                return;
            }
            
            // Hide paste area
            window.hidePasteArea();
            
            // Show processing message
            const fileNameDiv = document.getElementById('fileName');
            if (fileNameDiv) {
                fileNameDiv.innerHTML = `
                    <div class="spinner"></div>
                    <div style="margin-top: 12px;">Processing pasted data...</div>
                `;
            }
            
            // Process the data
            try {
                parseCSV(content);
                if (fileNameDiv) {
                    fileNameDiv.innerHTML = `
                        <div style="color: #48bb78;">‚úÖ Pasted data processed successfully!</div>
                    `;
                }
            } catch (error) {
                console.error('Error processing pasted data:', error);
                console.error('Stack:', error.stack);
                if (fileNameDiv) {
                    fileNameDiv.innerHTML = `
                        <div style="color: #f56565;">‚ùå Error processing data: ${error.message}</div>
                    `;
                }
                alert('Error processing data: ' + error.message + '\n\nCheck console (F12) for details.');
            }
        };

        // Load test data directly - bypasses all UI
        window.loadTestData = function() {
            console.log('=== LOADING TEST DATA DIRECTLY ===');
            
            const testCSV = `Date,Platform,Build,Test Owner,TestRail ID,Test Case,page_object_function,Test Status,page_object_class,failure_description,failure_exception,Report,Test Level,environment,id
"Nov 7, 2025",iOS,404796,VENDOR_DISCOVERY,673775,testOpenMenuBySearching,searchFor(keyword:searchFromKeyboard:),FAILED,VendorSearchFlow.swift,,"File: EarlGreyUITests|PageObjects|RestaurantsSearchExperience|VendorSearchFlow.swift | Line: 995 | failed: caught error: ""Error Domain=EarlGreyTest Code=0 ""None of the elements were visible and tappable."" UserInfo={NSLocalizedDescription=None of the elements were visible and tappable.}""",https://ios-ta-results.faster-food.net/bitrise_404796/index.html,E2E_TEST,MOCK_SERVER_2,BA3859A7-0572-4F98-A8AD-845FE89CD835
"Nov 7, 2025",iOS,404796,VENDOR_DISCOVERY,673775,testOpenMenuBySearching,tapOnElements(withIds:timeout:),FAILED,VendorSearchFlow.swift,,"File: EarlGreyUITests|PageObjects|RestaurantsSearchExperience|VendorSearchFlow.swift | Line: 995 | failed: caught error: ""Error Domain=EarlGreyTest Code=0 ""None of the elements were visible and tappable."" UserInfo={NSLocalizedDescription=None of the elements were visible and tappable.}""",https://ios-ta-results.faster-food.net/bitrise_404796/index.html,E2E_TEST,MOCK_SERVER_2,284CEA00-27D0-4701-8615-09155E5AE31F`;

            console.log('Test data length:', testCSV.length);
            
            const fileNameDiv = document.getElementById('fileName');
            if (fileNameDiv) {
                fileNameDiv.innerHTML = `
                    <div class="spinner"></div>
                    <div style="margin-top: 12px;">Loading test data...</div>
                `;
            }
            
            try {
                console.log('Calling parseCSV with test data...');
                parseCSV(testCSV);
                
                if (fileNameDiv) {
                    fileNameDiv.innerHTML = `
                        <div style="color: #48bb78;">‚úÖ Test data loaded successfully! (10 tests)</div>
                    `;
                }
                
                console.log('=== TEST DATA LOADED SUCCESSFULLY ===');
                
            } catch (error) {
                console.error('!!! ERROR LOADING TEST DATA !!!');
                console.error('Error:', error);
                console.error('Stack:', error.stack);
                
                if (fileNameDiv) {
                    fileNameDiv.innerHTML = `
                        <div style="color: #f56565;">‚ùå Error loading test data: ${error.message}</div>
                    `;
                }
                
                alert('Error loading test data: ' + error.message + '\n\nCheck console (F12) for details.');
            }
        };

        // Initialize file upload when DOM is ready
        function initFileUpload() {
            try {
                console.log('=== INITIALIZING FILE UPLOAD ===');
                
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                console.log('uploadArea element:', uploadArea);
                console.log('fileInput element:', fileInput);

                if (!uploadArea) {
                    console.error('ERROR: Upload area not found!');
                    alert('Error: Upload area element not found. Please refresh the page.');
                    return false;
                }
                
                if (!fileInput) {
                    console.error('ERROR: File input not found!');
                    alert('Error: File input element not found. Please refresh the page.');
                    return false;
                }

                console.log('‚úì Upload elements found successfully');
                console.log('‚úì handleFile function is available:', typeof handleFile);

                // Click handler
                uploadArea.addEventListener('click', function(e) {
                    console.log('Upload area clicked, target:', e.target.tagName);
                    if (e.target.tagName !== 'BUTTON') {
                        fileInput.click();
                    }
                });
                
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', function() {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    console.log('File dropped');
                    const file = e.dataTransfer.files[0];
                    handleFile(file);
                });

                fileInput.addEventListener('change', function(e) {
                    console.log('=== FILE INPUT CHANGE EVENT ===');
                    console.log('Event:', e);
                    console.log('Event target:', e.target);
                    console.log('Files array:', e.target.files);
                    console.log('Number of files:', e.target.files.length);
                    
                    if (e.target.files.length > 0) {
                        const file = e.target.files[0];
                        console.log('Selected file:', file);
                        console.log('File name:', file.name);
                        console.log('File size:', file.size);
                        console.log('File type:', file.type);
                        console.log('Calling handleFile...');
                        handleFile(file);
                    } else {
                        console.error('No file in files array!');
                    }
                });
                
                console.log('‚úì All event listeners attached successfully');
                console.log('=== FILE UPLOAD READY ===');
                return true;
                
            } catch (error) {
                console.error('!!! CRITICAL ERROR IN initFileUpload !!!');
                console.error('Error:', error);
                console.error('Stack:', error.stack);
                alert('Critical error initializing file upload: ' + error.message);
                return false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initFileUpload();
        });

        function parseCSV(content) {
            try {
                console.log('=== PARSING CSV ===');
                console.log('Content length:', content.length);
                console.log('First 500 chars:', content.substring(0, 500));
                
                // Normalize line endings - handle Windows (CRLF), Unix (LF), and old Mac (CR)
                content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                console.log('After normalizing line endings, length:', content.length);
                
                // Better CSV parsing that handles quoted fields
                const lines = content.trim().split('\n');
                console.log('Total lines:', lines.length);
                
                if (lines.length < 2) {
                    alert('CSV file appears to be empty or has only headers. Please check your file.');
                    return;
                }
                
                // Parse headers
                const headers = parseCSVLine(lines[0]).map(h => 
                    h.trim().toLowerCase().replace(/[^a-z_0-9]/g, '_')
                );
                
                console.log('Original headers:', parseCSVLine(lines[0]));
                console.log('Normalized headers:', headers);
                
                // Parse data rows
                testData = [];
                let skippedRows = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) {
                        skippedRows++;
                        continue; // Skip empty lines
                    }
                    
                    const values = parseCSVLine(lines[i]);
                    const obj = {};
                    
                    headers.forEach((header, index) => {
                        obj[header] = values[index]?.trim() || '';
                    });
                    
                    // Log first row for debugging
                    if (i === 1) {
                        console.log('First data row (raw):', lines[1]);
                        console.log('First data row (parsed):', obj);
                    }
                    
                    // Only add if it has a test case name
                    if (obj.test_case || obj.testcase || obj.test || obj.test_name) {
                        testData.push(obj);
                    } else {
                        skippedRows++;
                        if (i <= 5) {
                            console.warn(`Row ${i} skipped - no test_case found:`, obj);
                        }
                    }
                }
                
                console.log('Parsed test data:', testData.length, 'records');
                console.log('Skipped rows:', skippedRows);
                
                if (testData.length === 0) {
                    console.error('No valid test data found!');
                    console.log('Headers found:', headers);
                    console.log('Looking for one of: test_case, testcase, test, test_name');
                    alert('No test data found. Please check your CSV format.\n\nRequired: A column named "Test Case", "test_case", "test", or "test_name"\n\nYour headers: ' + headers.join(', '));
                    return;
                }
                
                console.log('Sample of first 3 tests:', testData.slice(0, 3));
                
                // Normalize column names to match dashboard expectations
                console.log('=== NORMALIZING DATA ===');
                testData = testData.map((test, index) => {
                    const normalized = normalizeTestData(test);
                    if (index === 0) {
                        console.log('First test before normalization:', test);
                        console.log('First test after normalization:', normalized);
                    }
                    return normalized;
                });
                
                console.log('After normalization, test count:', testData.length);
                console.log('Sample normalized test:', testData[0]);
                
                filteredData = [...testData];
                
                console.log('=== CALLING ANALYZE DATA ===');
                analyzeData();
                console.log('=== ANALYZE DATA COMPLETED ===');
                
            } catch (error) {
                console.error('!!! ERROR PARSING CSV !!!');
                console.error('Error:', error);
                console.error('Stack:', error.stack);
                alert('Error parsing CSV file: ' + error.message + '\n\nCheck browser console (F12) for details.');
            }
        }
        
        // Helper function to parse a CSV line handling quoted fields
        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote state
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // Field separator
                    values.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add last field
            values.push(current);
            
            return values;
        }

        // Normalize user's column names to dashboard format
        function normalizeTestData(test) {
            const normalized = {};
            
            // Test Case Name - map from "Test Case" or "test_case"
            normalized.test_case = test.test_case || test.testcase || test.test || test.test_name || 'Unknown Test';
            
            // Test ID - map from "TestRail ID" or "id"  
            normalized.test_id = test.testrail_id || test.test_id || test.id || 'N/A';
            
            // Platform - map from "Platform"
            normalized.platform = test.platform || 'Unknown';
            
            // Date - map from "Date"
            let date = test.date || new Date().toISOString().split('T')[0];
            // Try to parse various date formats
            if (date && date !== 'Unknown') {
                try {
                    // Handle "Nov 7, 2025" format
                    const parsed = new Date(date);
                    if (!isNaN(parsed.getTime())) {
                        date = parsed.toISOString().split('T')[0];
                    }
                } catch (e) {
                    console.warn('Could not parse date:', date);
                }
            }
            normalized.date = date;
            
            // Team Name - map from "Test Owner"
            normalized.team_name = test.test_owner || test.team_name || test.team || 'Unknown Team';
            
            // Failure Description - combine failure_description and failure_exception
            const desc = test.failure_description || test.description || test.error || '';
            const exception = test.failure_exception || '';
            normalized.failure_description = exception ? `${desc}\n\n${exception}` : desc;
            
            // Stack Trace - map from page_object_class and page_object_function
            const pageClass = test.page_object_class || '';
            const pageFunction = test.page_object_function || '';
            if (pageClass || pageFunction) {
                normalized.stack_trace = `File: ${pageClass}\nFunction: ${pageFunction}`;
            } else {
                normalized.stack_trace = test.stack_trace || test.stacktrace || '';
            }
            
            // Additional fields that might be useful
            normalized.build = test.build || '';
            normalized.environment = test.environment || '';
            normalized.test_level = test.test_level || '';
            normalized.test_status = test.test_status || 'FAILED';
            normalized.report = test.report || '';
            
            return normalized;
        }

        function analyzeData() {
            if (testData.length === 0) return;

            // Show dashboard
            document.getElementById('dashboard').style.display = 'block';

            // Update stats
            document.getElementById('totalFailures').textContent = testData.length;

            const platforms = [...new Set(testData.map(t => t.platform || t.Platform || 'Unknown'))];
            document.getElementById('totalPlatforms').textContent = platforms.length;

            const teams = [...new Set(testData.map(t => t.team_name || t.team || t.Team || 'Unknown'))];
            document.getElementById('totalTeams').textContent = teams.length;

            // Populate filters
            const platformFilter = document.getElementById('platformFilter');
            platforms.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                platformFilter.appendChild(option);
            });

            const teamFilter = document.getElementById('teamFilter');
            teams.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                teamFilter.appendChild(option);
            });

            // Add filter listeners
            document.getElementById('platformFilter').addEventListener('change', applyFilters);
            document.getElementById('teamFilter').addEventListener('change', applyFilters);
            document.getElementById('severityFilter').addEventListener('change', applyFilters);

            // Run AI analysis
            groupFailures();
            generateInsights();
            createCharts();
            generateTrendAnalysis();
            generateRootCauseAnalysis();
            
            // Set up search
            setupSearch();
            
            // Set up scroll to top button
            setupScrollToTop();
            
            // Initialize date range with data bounds
            initializeDateRange();
        }

        function setupSearch() {
            const searchBox = document.getElementById('searchBox');
            const searchResults = document.getElementById('searchResults');
            
            searchBox.addEventListener('input', (e) => {
                const query = e.target.value.trim().toLowerCase();
                
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('active');
                }
            });
            
            // Handle Enter key
            searchBox.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstResult = searchResults.querySelector('.search-result-item');
                    if (firstResult) {
                        firstResult.click();
                    }
                }
            });
        }

        function performSearch(query) {
            const searchResults = document.getElementById('searchResults');
            
            const results = testData.filter(test => {
                const testName = (test.test_case || test.testcase || test.test || test.test_name || '').toLowerCase();
                const testId = (test.test_id || test.id || '').toLowerCase();
                const description = (test.failure_description || test.description || test.error || '').toLowerCase();
                
                return testName.includes(query) || testId.includes(query) || description.includes(query);
            }).slice(0, 10); // Limit to 10 results
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div style="padding: 16px; color: #718096; text-align: center;">No results found</div>';
            } else {
                searchResults.innerHTML = results.map((test, index) => {
                    const testName = test.test_case || test.testcase || test.test || test.test_name || 'Unknown';
                    const highlightedName = highlightText(testName, query);
                    
                    return `
                        <div class="search-result-item" onclick="showTestDetail(${testData.indexOf(test)})">
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 4px;">
                                ${highlightedName}
                            </div>
                            <div style="font-size: 12px; color: #718096;">
                                <span class="platform-badge platform-${(test.platform || 'unknown').toLowerCase()}">
                                    ${test.platform || 'Unknown'}
                                </span>
                                ${test.team_name || test.team || 'Unknown Team'} ‚Ä¢ ${test.date || 'No date'}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            searchResults.classList.add('active');
        }

        function highlightText(text, query) {
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        function showTestDetail(index) {
            console.log('showTestDetail called with index:', index);
            
            if (index < 0 || index >= testData.length) {
                console.error('Invalid test index:', index);
                alert('Error: Test not found');
                return;
            }
            
            const test = testData[index];
            console.log('Test data:', test);
            
            const modal = document.getElementById('testDetailModal');
            const modalBody = document.getElementById('modalBody');
            
            if (!modal || !modalBody) {
                console.error('Modal elements not found');
                return;
            }
            
            const testName = test.test_case || test.testcase || test.test || test.test_name || 'Unknown';
            const testId = test.test_id || test.id || 'N/A';
            const description = test.failure_description || test.description || test.error || 'No description';
            const platform = test.platform || 'Unknown';
            const date = test.date || 'No date';
            const team = test.team_name || test.team || 'Unknown';
            const stackTrace = test.stack_trace || test.stacktrace || 'Not available';
            const severity = determineSeverity(test);
            
            modalBody.innerHTML = `
                <div class="detail-section">
                    <div class="detail-label">Test ID</div>
                    <div class="detail-value">${testId}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">Test Name</div>
                    <div class="detail-value" style="font-size: 16px; font-weight: 600;">${testName}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">Failure Description</div>
                    <div class="detail-value" style="background: #f7fafc; padding: 12px; border-radius: 6px; border-left: 4px solid #f56565;">
                        ${description}
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="detail-section">
                        <div class="detail-label">Platform</div>
                        <div class="detail-value">
                            <span class="platform-badge platform-${platform.toLowerCase()}">${platform}</span>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Date</div>
                        <div class="detail-value">${date}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Team</div>
                        <div class="detail-value">${team}</div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-label">Severity</div>
                        <div class="detail-value">
                            ${getSeverityEmoji(severity)} ${severity.toUpperCase()}
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">AI Classification</div>
                    <div class="detail-value">${extractPattern(description)}</div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-label">Stack Trace / Additional Info</div>
                    <div class="detail-value" style="background: #1a202c; color: #e2e8f0; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">
${stackTrace}</div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" onclick="exportTest(${index})">üìã Export Details</button>
                    <button class="btn" style="background: #48bb78;" onclick="createTicket(${index})">üé´ Create Ticket</button>
                    <button class="btn" style="background: #718096;" onclick="findSimilar(${index})">üîç Find Similar</button>
                </div>
            `;
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Close search results
            document.getElementById('searchResults').classList.remove('active');
        }

        function closeTestDetail() {
            const modal = document.getElementById('testDetailModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('testDetailModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeTestDetail();
                    }
                });
            }
        });

        function determineSeverity(test) {
            const description = (test.failure_description || '').toLowerCase();
            if (description.includes('crash') || description.includes('critical')) return 'critical';
            if (description.includes('timeout') || description.includes('null')) return 'high';
            return 'medium';
        }

        function exportTest(index) {
            const test = testData[index];
            const json = JSON.stringify(test, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `test-failure-${index + 1}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function createTicket(index) {
            const test = testData[index];
            alert(`Feature: Create JIRA/Linear ticket for:\n${test.test_case || test.testcase || 'Unknown test'}`);
        }

        function findSimilar(index) {
            const test = testData[index];
            const pattern = extractPattern(test.failure_description || '');
            
            // Filter by same pattern
            filteredData = testData.filter(t => extractPattern(t.failure_description || '') === pattern);
            
            closeTestDetail();
            currentPage = 1;
            groupFailures();
            
            // Scroll to grouped failures
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
        }

        function setupScrollToTop() {
            const scrollBtn = document.getElementById('scrollToTop');
            
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    scrollBtn.classList.add('visible');
                } else {
                    scrollBtn.classList.remove('visible');
                }
            });
        }

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showToast(message, duration = 2000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('visible');
            
            setTimeout(() => {
                toast.classList.remove('visible');
            }, duration);
        }

        function initializeDateRange() {
            const dates = testData.map(t => t.date || '').filter(d => d).sort();
            if (dates.length > 0) {
                document.getElementById('dateFrom').value = dates[0];
                document.getElementById('dateTo').value = dates[dates.length - 1];
            }
        }

        function setView(view) {
            currentView = view;
            document.getElementById('combinedViewBtn').classList.toggle('active', view === 'combined');
            document.getElementById('dailyViewBtn').classList.toggle('active', view === 'daily');
            document.getElementById('platformViewBtn').classList.toggle('active', view === 'platform');
            groupFailures();
        }

        function applyDateRange() {
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;
            
            if (!from || !to) {
                alert('Please select both from and to dates');
                return;
            }
            
            selectedDateRange = { from, to };
            
            // Filter data by date range
            filteredData = testData.filter(test => {
                const testDate = test.date || '';
                return testDate >= from && testDate <= to;
            });
            
            // Update stats
            document.getElementById('dateRangeStat').textContent = `${from} to ${to}`;
            document.getElementById('totalFailures').textContent = filteredData.length;
            
            currentPage = 1;
            groupFailures();
            generateInsights();
            createCharts();
            generateTrendAnalysis();
        }

        function clearDateRange() {
            selectedDateRange = { from: null, to: null };
            filteredData = [...testData];
            
            document.getElementById('dateRangeStat').textContent = 'All';
            document.getElementById('totalFailures').textContent = testData.length;
            
            // Reset date inputs
            initializeDateRange();
            
            currentPage = 1;
            applyFilters();
        }

        function applyFilters() {
            const platform = document.getElementById('platformFilter').value;
            const team = document.getElementById('teamFilter').value;
            const severity = document.getElementById('severityFilter').value;

            filteredData = testData.filter(item => {
                const itemPlatform = item.platform || item.Platform || 'Unknown';
                const itemTeam = item.team_name || item.team || item.Team || 'Unknown';
                
                return (platform === 'all' || itemPlatform === platform) &&
                       (team === 'all' || itemTeam === team);
            });

            groupFailures();
            generateInsights();
            createCharts();
        }

        function groupFailures() {
            if (currentView === 'daily') {
                groupFailuresByDate();
            } else if (currentView === 'platform') {
                groupFailuresByPlatform();
            } else {
                groupFailuresCombined();
            }
        }

        function groupFailuresByDate() {
            // Group by date first, then by pattern within each date
            const dateGroups = {};
            
            filteredData.forEach(test => {
                const date = test.date || 'Unknown Date';
                if (!dateGroups[date]) {
                    dateGroups[date] = [];
                }
                dateGroups[date].push(test);
            });
            
            const container = document.getElementById('groupedFailures');
            const sortedDates = Object.keys(dateGroups).sort().reverse(); // Most recent first
            
            document.getElementById('totalGroups').textContent = sortedDates.length;
            
            let html = '';
            sortedDates.forEach((date, dateIndex) => {
                const testsForDate = dateGroups[date];
                
                // Group tests by pattern for this date
                const patternGroups = {};
                testsForDate.forEach(test => {
                    const pattern = extractPattern(test.failure_description || '');
                    if (!patternGroups[pattern]) {
                        patternGroups[pattern] = [];
                    }
                    patternGroups[pattern].push(test);
                });
                
                const sortedPatterns = Object.entries(patternGroups).sort((a, b) => b[1].length - a[1].length);
                
                html += `
                    <div class="date-group-header">
                        <span>üìÖ ${date}</span>
                        <span>${testsForDate.length} failures</span>
                    </div>
                `;
                
                sortedPatterns.forEach(([pattern, tests], patternIndex) => {
                    const severity = tests.length > 10 ? 'critical' : tests.length > 5 ? 'high' : 'medium';
                    const groupId = `date-${dateIndex}-pattern-${patternIndex}`;
                    
                    html += `
                        <div class="group-item severity-${severity}" onclick="toggleGroup('${groupId}')">
                            <div class="group-header">
                                <div class="group-title">${pattern}</div>
                                <div class="group-count">${tests.length}</div>
                            </div>
                            <div class="group-description">
                                ${getSeverityEmoji(severity)} ${severity.toUpperCase()} - 
                                Affects ${[...new Set(tests.map(t => t.platform || 'Unknown'))].join(', ')}
                                <span style="color: #667eea; font-size: 11px; margin-left: 8px;">‚Ä¢ Click to expand</span>
                            </div>
                            <div class="group-tests" id="${groupId}">
                                ${tests.slice(0, 10).map(test => {
                                    const testIndex = testData.indexOf(test);
                                    return `
                                        <div class="test-item" onclick="event.stopPropagation(); showTestDetail(${testIndex});" style="cursor: pointer;">
                                            <div class="test-name">${test.test_case || test.testcase || test.test || 'Unknown'}</div>
                                            <div class="test-meta">
                                                <span class="platform-badge platform-${(test.platform || 'unknown').toLowerCase()}">
                                                    ${test.platform || 'Unknown'}
                                                </span>
                                                ${test.team_name || test.team || 'Unknown Team'}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${tests.length > 10 ? `
                                    <div style="text-align: center; color: #718096; font-size: 12px; margin-top: 8px;">
                                        + ${tests.length - 10} more (click to view all)
                                    </div>
                                ` : ''}
                                <button class="action-btn" onclick="event.stopPropagation(); createGroupTicket('${groupId}', '${pattern}', ${tests.length})">
                                    üìã Create Ticket for Group
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html;
        }

        function groupFailuresByPlatform() {
            // Group by platform first, then by pattern within each platform
            const platformGroups = {};
            
            filteredData.forEach(test => {
                const platform = test.platform || 'Unknown';
                if (!platformGroups[platform]) {
                    platformGroups[platform] = [];
                }
                platformGroups[platform].push(test);
            });
            
            const container = document.getElementById('groupedFailures');
            const platforms = Object.keys(platformGroups).sort();
            
            // Count unique patterns across all platforms for total groups
            const allPatterns = new Set();
            Object.values(platformGroups).forEach(tests => {
                tests.forEach(test => {
                    allPatterns.add(extractPattern(test.failure_description || ''));
                });
            });
            document.getElementById('totalGroups').textContent = allPatterns.size;
            
            let html = '';
            
            platforms.forEach((platform, platformIndex) => {
                const testsForPlatform = platformGroups[platform];
                
                // Group tests by pattern for this platform
                const patternGroups = {};
                testsForPlatform.forEach(test => {
                    const pattern = extractPattern(test.failure_description || '');
                    if (!patternGroups[pattern]) {
                        patternGroups[pattern] = [];
                    }
                    patternGroups[pattern].push(test);
                });
                
                const sortedPatterns = Object.entries(patternGroups).sort((a, b) => b[1].length - a[1].length);
                
                // Get platform icon and color
                const platformInfo = getPlatformInfo(platform);
                
                html += `
                    <div class="date-group-header" style="background: ${platformInfo.gradient};">
                        <span>${platformInfo.icon} ${platform}</span>
                        <span>${testsForPlatform.length} failures</span>
                    </div>
                `;
                
                sortedPatterns.forEach(([pattern, tests], patternIndex) => {
                    const severity = tests.length > 10 ? 'critical' : tests.length > 5 ? 'high' : 'medium';
                    const groupId = `platform-${platformIndex}-pattern-${patternIndex}`;
                    
                    // Get unique teams for this pattern on this platform
                    const teams = [...new Set(tests.map(t => t.team_name || t.team || 'Unknown'))];
                    
                    html += `
                        <div class="group-item severity-${severity}" onclick="toggleGroup('${groupId}')">
                            <div class="group-header">
                                <div class="group-title">${pattern}</div>
                                <div class="group-count">${tests.length}</div>
                            </div>
                            <div class="group-description">
                                ${getSeverityEmoji(severity)} ${severity.toUpperCase()} - 
                                Affects ${teams.length} team${teams.length > 1 ? 's' : ''}: ${teams.slice(0, 3).join(', ')}${teams.length > 3 ? '...' : ''}
                                <span style="color: #667eea; font-size: 11px; margin-left: 8px;">‚Ä¢ Click to expand</span>
                            </div>
                            <div class="group-tests" id="${groupId}">
                                ${tests.slice(0, 10).map(test => {
                                    const testIndex = testData.indexOf(test);
                                    return `
                                        <div class="test-item" onclick="event.stopPropagation(); showTestDetail(${testIndex});" style="cursor: pointer;">
                                            <div class="test-name">${test.test_case || test.testcase || test.test || 'Unknown'}</div>
                                            <div class="test-meta">
                                                ${test.team_name || test.team || 'Unknown Team'} ‚Ä¢ ${test.date || 'No date'}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                ${tests.length > 10 ? `
                                    <div style="text-align: center; color: #718096; font-size: 12px; margin-top: 8px;">
                                        + ${tests.length - 10} more (click to view all)
                                    </div>
                                ` : ''}
                                <button class="action-btn" onclick="event.stopPropagation(); createGroupTicket('${groupId}', '${platform} - ${pattern}', ${tests.length})">
                                    üìã Create Ticket for Group
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
            
            container.innerHTML = html;
        }

        function getPlatformInfo(platform) {
            const platformLower = platform.toLowerCase();
            
            const info = {
                'android': {
                    icon: 'ü§ñ',
                    gradient: 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)',
                    color: '#48bb78'
                },
                'ios': {
                    icon: 'üçé',
                    gradient: 'linear-gradient(135deg, #4299e1 0%, #3182ce 100%)',
                    color: '#4299e1'
                },
                'web': {
                    icon: 'üåê',
                    gradient: 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)',
                    color: '#ed8936'
                }
            };
            
            return info[platformLower] || {
                icon: 'üì±',
                gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                color: '#667eea'
            };
        }

        function groupFailuresCombined() {
            // Use advanced AI-powered grouping with similarity analysis
            const groups = advancedGrouping(filteredData, 0.75);

            const sortedGroups = Object.values(groups).sort((a, b) => b.tests.length - a.tests.length);

            document.getElementById('totalGroups').textContent = sortedGroups.length;

            // Pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedGroups = sortedGroups.slice(startIndex, endIndex);

            const container = document.getElementById('groupedFailures');
            container.innerHTML = paginatedGroups.map((group, index) => {
                const actualIndex = startIndex + index;
                const groupId = `group-${actualIndex}`;
                const rootCause = group.rootCause;
                
                return `
                    <div class="group-item severity-${group.severity}" onclick="toggleGroup('${groupId}')">
                        <div class="group-header">
                            <div class="group-title">${group.pattern}</div>
                            <div class="group-count">${group.tests.length}</div>
                        </div>
                        <div class="group-description">
                            ${getSeverityEmoji(group.severity)} ${group.severity.toUpperCase()} - 
                            Affects ${[...new Set(group.tests.map(t => t.platform || 'Unknown'))].join(', ')}
                            <span style="color: #667eea; font-size: 11px; margin-left: 8px;">‚Ä¢ Click to expand</span>
                        </div>
                        ${rootCause && rootCause.confidence > 0.6 ? `
                            <div style="background: #edf2f7; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid ${rootCause.confidence > 0.8 ? '#48bb78' : '#ed8936'};">
                                <div style="font-weight: 600; color: #2d3748; font-size: 12px; margin-bottom: 4px;">
                                    üî¨ Root Cause Analysis (${Math.round(rootCause.confidence * 100)}% confidence)
                                </div>
                                <div style="color: #2d3748; font-size: 13px; font-weight: 600; margin-bottom: 4px;">
                                    ${rootCause.likelyRootCause}
                                </div>
                                ${rootCause.reasoning.length > 0 ? `
                                    <div style="color: #718096; font-size: 11px;">
                                        ${rootCause.reasoning.slice(0, 2).join(' ‚Ä¢ ')}
                                    </div>
                                ` : ''}
                                ${rootCause.errorCodes.length > 0 ? `
                                    <div style="margin-top: 6px;">
                                        ${rootCause.errorCodes.map(code => `
                                            <span style="background: #fc8181; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-right: 4px;">
                                                HTTP ${code}
                                            </span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        <div class="group-tests" id="${groupId}">
                            ${group.tests.slice(0, 10).map(test => {
                                const testIndex = testData.indexOf(test);
                                return `
                                    <div class="test-item" onclick="event.stopPropagation(); showTestDetail(${testIndex});" style="cursor: pointer;">
                                        <div class="test-name">${test.test_case || test.testcase || test.test || 'Unknown'}</div>
                                        <div class="test-meta">
                                            <span class="platform-badge platform-${(test.platform || 'unknown').toLowerCase()}">
                                                ${test.platform || 'Unknown'}
                                            </span>
                                            ${test.team_name || test.team || 'Unknown Team'} ‚Ä¢ 
                                            ${test.date || 'No date'}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            ${group.tests.length > 10 ? `
                                <div style="text-align: center; color: #718096; font-size: 12px; margin-top: 8px;">
                                    + ${group.tests.length - 10} more (click to view all)
                                </div>
                            ` : ''}
                            <button class="action-btn" onclick="event.stopPropagation(); createGroupTicket('${groupId}', '${group.pattern}', ${group.tests.length})">
                                üìã Create Ticket for Group
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // Add pagination controls if needed
            if (sortedGroups.length > itemsPerPage) {
                const totalPages = Math.ceil(sortedGroups.length / itemsPerPage);
                container.innerHTML += `
                    <div class="pagination">
                        <button class="pagination-btn" onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>
                            ‚Äπ‚Äπ First
                        </button>
                        <button class="pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                            ‚Äπ Previous
                        </button>
                        <span style="color: #718096; padding: 0 16px;">
                            Page ${currentPage} of ${totalPages}
                        </span>
                        <button class="pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                            Next ‚Ä∫
                        </button>
                        <button class="pagination-btn" onclick="changePage(${totalPages})" ${currentPage === totalPages ? 'disabled' : ''}>
                            Last ‚Ä∫‚Ä∫
                        </button>
                    </div>
                `;
            }
        }

        function changePage(page) {
            currentPage = page;
            groupFailures();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function toggleGroup(groupId) {
            console.log('toggleGroup called with:', groupId);
            const group = document.getElementById(groupId);
            
            if (!group) {
                console.error('Group not found:', groupId);
                return;
            }
            
            const groupItem = group.parentElement;
            console.log('Found group element, toggling expanded class');
            
            group.classList.toggle('expanded');
            
            if (groupItem && groupItem.classList.contains('group-item')) {
                groupItem.classList.toggle('expanded');
                console.log('Toggled group-item expanded class');
            }
        }

        function createGroupTicket(groupId, pattern, count) {
            alert(`Feature: Create ticket for group "${pattern}" with ${count} test failures`);
        }

        function extractPattern(description) {
            // AI-like pattern extraction
            const patterns = [
                // Specific Android/Compose errors
                { regex: /Assert failed: The component with TestTag = 'AccountTabSignInHeaderItem' is not displayed!/i, label: 'UI: Account Sign-In Header Not Displayed' },
                { regex: /Failed: assertExists\. Reason: Expected exactly '1' node but could not find any node that satisfies: \(Text \+ InputText \+ EditableText contains 'Added to Favourites' \(ignoreCase: false\)\)/i, label: 'UI: Favourites Snackbar Not Found (Added)' },
                { regex: /Failed: assertExists\. Reason: Expected exactly '1' node but could not find any node that satisfies: \(Text \+ InputText \+ EditableText contains 'Removed from Favourites' \(ignoreCase: false\)\)/i, label: 'UI: Favourites Snackbar Not Found (Removed)' },
                { regex: /Condition still not satisfied after \d+ ms/i, label: 'Timeout: Condition Not Met' },
                { regex: /java\.lang\.Object androidx\.compose\.runtime\.saveable\.RememberSaveableKt\.rememberSaveable/i, label: 'Android Compose: RememberSaveable Issue' },
                { regex: /Could not initialize class org\.robolectric\.android\.Bootstrap/i, label: 'Android Test: Robolectric Init Error' },
                { regex: /Dispatchers\.Main is used concurrently with setting it/i, label: 'Android Concurrency: Dispatchers.Main Issue' },
                { regex: /Only the original thread that created a view hierarchy can touch its views\./i, label: 'Android UI: Thread Violation' },

                // General patterns (keep these as fallbacks)
                { regex: /assert.*failed/i, label: 'Assertion Failures' },
                { regex: /not displayed|not visible|not found/i, label: 'UI Element Not Found' },
                { regex: /timeout|timed out/i, label: 'Timeout Issues' },
                { regex: /network|connection|api/i, label: 'Network/API Issues' },
                { regex: /null|undefined|nil/i, label: 'Null/Undefined Errors' },
                { regex: /permission|access denied/i, label: 'Permission Errors' },
                { regex: /crash|exception/i, label: 'Crashes & Exceptions' },
                { regex: /404 not found/i, label: 'API: 404 Not Found' },
                { regex: /500 internal server error/i, label: 'API: 500 Server Error' },
                { regex: /503 service unavailable/i, label: 'API: 503 Service Unavailable' },
                { regex: /401 unauthorized/i, label: 'API: 401 Unauthorized' },
                { regex: /403 forbidden/i, label: 'API: 403 Forbidden' },
                { regex: /element not found|could not find element/i, label: 'UI: Element Not Found' },
                { regex: /element not visible|element is not displayed/i, label: 'UI: Element Not Visible' },
                { regex: /element not interactable|element not clickable/i, label: 'UI: Element Not Interactable' },
                { regex: /expected.*to be.*but got/i, label: 'Assertion: Value Mismatch' },
            ];

            for (const pattern of patterns) {
                if (pattern.regex.test(description)) {
                    return pattern.label;
                }
            }

            return 'Other Failures';
        }

        // Enhanced grouping algorithms
        
        // 1. Levenshtein Distance for string similarity
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = [];

            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    if (str1.charAt(i - 1) === str2.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[len1][len2];
        }

        function stringSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) {
                return 1.0;
            }
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // 2. Extract error codes from descriptions
        function extractErrorCodes(description) {
            const codes = {
                httpCodes: [],
                errorTypes: [],
                exceptionTypes: []
            };

            // HTTP status codes
            const httpMatch = description.match(/\b([1-5]\d{2})\b/g);
            if (httpMatch) {
                codes.httpCodes = [...new Set(httpMatch)];
            }

            // Common error types
            const errorPatterns = [
                /ConnectionError/i,
                /TimeoutError/i,
                /NetworkError/i,
                /DatabaseError/i,
                /AuthenticationError/i,
                /ValidationError/i,
                /NotFoundException/i,
                /ServerError/i
            ];

            errorPatterns.forEach(pattern => {
                const match = description.match(pattern);
                if (match) {
                    codes.errorTypes.push(match[0]);
                }
            });

            // Exception types
            const exceptionMatch = description.match(/(\w+Exception|\w+Error)/g);
            if (exceptionMatch) {
                codes.exceptionTypes = [...new Set(exceptionMatch)];
            }

            return codes;
        }

        // 3. Stack trace similarity
        function extractStackTraceSignature(stackTrace) {
            if (!stackTrace || stackTrace === 'Not available') {
                return null;
            }

            // Extract function calls and file paths
            const lines = stackTrace.split('\n');
            const signature = [];

            lines.forEach(line => {
                // Match common stack trace patterns
                const patterns = [
                    /at\s+(\w+\.?\w*)/,  // Java/JavaScript style
                    /in\s+(\w+\.?\w*)/,   // Python style
                    /(\w+\.\w+)\s*\(/     // Function calls
                ];

                for (const pattern of patterns) {
                    const match = line.match(pattern);
                    if (match) {
                        signature.push(match[1]);
                        break;
                    }
                }
            });

            return signature.slice(0, 5).join('‚Üí'); // Top 5 calls
        }

        function stackTraceSimilarity(trace1, trace2) {
            const sig1 = extractStackTraceSignature(trace1);
            const sig2 = extractStackTraceSignature(trace2);

            if (!sig1 || !sig2) return 0;
            if (sig1 === sig2) return 1.0;

            return stringSimilarity(sig1, sig2);
        }

        // 4. Test name similarity
        function normalizeTestName(testName) {
            // Remove numbers, underscores, and normalize
            return testName
                .toLowerCase()
                .replace(/[_\-]/g, ' ')
                .replace(/\d+/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function testNameSimilarity(name1, name2) {
            const norm1 = normalizeTestName(name1);
            const norm2 = normalizeTestName(name2);
            return stringSimilarity(norm1, norm2);
        }

        // 5. Root cause detection
        function detectRootCause(tests) {
            const analysis = {
                likelyRootCause: 'Unknown',
                confidence: 0,
                reasoning: [],
                errorCodes: [],
                commonPatterns: []
            };

            // Analyze error codes
            const allErrorCodes = { httpCodes: {}, errorTypes: {}, exceptionTypes: {} };
            
            tests.forEach(test => {
                const codes = extractErrorCodes(test.failure_description || '');
                
                codes.httpCodes.forEach(code => {
                    allErrorCodes.httpCodes[code] = (allErrorCodes.httpCodes[code] || 0) + 1;
                });
                
                codes.errorTypes.forEach(type => {
                    allErrorCodes.errorTypes[type] = (allErrorCodes.errorTypes[type] || 0) + 1;
                });
                
                codes.exceptionTypes.forEach(type => {
                    allErrorCodes.exceptionTypes[type] = (allErrorCodes.exceptionTypes[type] || 0) + 1;
                });
            });

            // Determine root cause based on patterns
            const threshold = tests.length * 0.6; // 60% of tests

            // Check HTTP codes
            Object.entries(allErrorCodes.httpCodes).forEach(([code, count]) => {
                if (count > threshold) {
                    analysis.errorCodes.push(code);
                    analysis.confidence = Math.min(0.9, count / tests.length);
                    
                    if (code === '500') {
                        analysis.likelyRootCause = 'Backend Server Error';
                        analysis.reasoning.push(`${count} tests show HTTP 500 errors`);
                    } else if (code === '503') {
                        analysis.likelyRootCause = 'Service Unavailable / Overload';
                        analysis.reasoning.push(`${count} tests show HTTP 503 errors`);
                    } else if (code === '401' || code === '403') {
                        analysis.likelyRootCause = 'Authentication/Authorization Failure';
                        analysis.reasoning.push(`${count} tests show auth errors`);
                    } else if (code === '404') {
                        analysis.likelyRootCause = 'Missing Resource / Broken Endpoint';
                        analysis.reasoning.push(`${count} tests show 404 errors`);
                    } else if (code === '429') {
                        analysis.likelyRootCause = 'API Rate Limiting';
                        analysis.reasoning.push(`${count} tests show rate limit errors`);
                    }
                }
            });

            // Check error types
            Object.entries(allErrorCodes.errorTypes).forEach(([type, count]) => {
                if (count > threshold) {
                    if (type.match(/timeout/i)) {
                        analysis.likelyRootCause = 'System-Wide Timeout Issues';
                        analysis.reasoning.push(`${count} tests timing out`);
                        analysis.confidence = Math.max(analysis.confidence, 0.85);
                    } else if (type.match(/connection|network/i)) {
                        analysis.likelyRootCause = 'Network Connectivity Issues';
                        analysis.reasoning.push(`${count} tests have connection errors`);
                        analysis.confidence = Math.max(analysis.confidence, 0.85);
                    } else if (type.match(/database/i)) {
                        analysis.likelyRootCause = 'Database Connection/Query Issues';
                        analysis.reasoning.push(`${count} tests have database errors`);
                        analysis.confidence = Math.max(analysis.confidence, 0.85);
                    }
                }
            });

            // Check for common keywords
            const descriptions = tests.map(t => (t.failure_description || '').toLowerCase());
            const keywords = {
                'pool': 0,
                'exhausted': 0,
                'connection refused': 0,
                'out of memory': 0,
                'deadlock': 0,
                'race condition': 0
            };

            descriptions.forEach(desc => {
                Object.keys(keywords).forEach(keyword => {
                    if (desc.includes(keyword)) {
                        keywords[keyword]++;
                    }
                });
            });

            if (keywords['pool'] > threshold || keywords['exhausted'] > threshold) {
                analysis.likelyRootCause = 'Resource Pool Exhaustion (DB/Connection Pool)';
                analysis.reasoning.push('Multiple tests mention pool/exhaustion');
                analysis.confidence = Math.max(analysis.confidence, 0.9);
            }

            if (keywords['out of memory'] > threshold) {
                analysis.likelyRootCause = 'Memory Leak / Insufficient Memory';
                analysis.reasoning.push('Memory issues detected');
                analysis.confidence = Math.max(analysis.confidence, 0.9);
            }

            // Stack trace analysis
            const stackTraces = tests.map(t => t.stack_trace || t.stacktrace).filter(s => s && s !== 'Not available');
            if (stackTraces.length > 2) {
                const signatures = stackTraces.map(extractStackTraceSignature).filter(s => s);
                const uniqueSignatures = [...new Set(signatures)];
                
                if (uniqueSignatures.length === 1) {
                    analysis.reasoning.push('All failures have identical stack traces');
                    analysis.confidence = Math.max(analysis.confidence, 0.95);
                } else if (uniqueSignatures.length <= 3) {
                    analysis.reasoning.push(`${uniqueSignatures.length} similar stack trace patterns found`);
                    analysis.confidence = Math.max(analysis.confidence, 0.8);
                }
            }

            return analysis;
        }

        // 6. Advanced grouping with similarity
        function advancedGrouping(tests, similarityThreshold = 0.75) {
            const groups = {};
            const processed = new Set();

            tests.forEach((test, index) => {
                if (processed.has(index)) return;

                const testName = test.test_case || test.testcase || test.test || 'Unknown';
                const description = test.failure_description || test.description || test.error || '';
                const stackTrace = test.stack_trace || test.stacktrace || '';
                const errorCodes = extractErrorCodes(description);

                // Find similar tests
                const similarTests = [test];
                processed.add(index);

                tests.forEach((otherTest, otherIndex) => {
                    if (processed.has(otherIndex) || index === otherIndex) return;

                    const otherName = otherTest.test_case || otherTest.testcase || otherTest.test || 'Unknown';
                    const otherDesc = otherTest.failure_description || otherTest.description || otherTest.error || '';
                    const otherStack = otherTest.stack_trace || otherTest.stacktrace || '';
                    const otherCodes = extractErrorCodes(otherDesc);

                    let similarityScore = 0;
                    let factors = 0;

                    // Test name similarity
                    const nameSim = testNameSimilarity(testName, otherName);
                    if (nameSim > 0.7) {
                        similarityScore += nameSim;
                        factors++;
                    }

                    // Description similarity
                    const descSim = stringSimilarity(description, otherDesc);
                    if (descSim > 0.6) {
                        similarityScore += descSim;
                        factors++;
                    }

                    // Stack trace similarity
                    if (stackTrace && otherStack) {
                        const stackSim = stackTraceSimilarity(stackTrace, otherStack);
                        if (stackSim > 0.7) {
                            similarityScore += stackSim * 1.5; // Weight stack traces higher
                            factors += 1.5;
                        }
                    }

                    // Error code matching
                    const commonHttpCodes = errorCodes.httpCodes.filter(c => otherCodes.httpCodes.includes(c));
                    const commonExceptions = errorCodes.exceptionTypes.filter(e => otherCodes.exceptionTypes.includes(e));
                    
                    if (commonHttpCodes.length > 0) {
                        similarityScore += 0.8;
                        factors++;
                    }
                    
                    if (commonExceptions.length > 0) {
                        similarityScore += 0.7;
                        factors++;
                    }

                    // Calculate average similarity
                    if (factors > 0) {
                        const avgSimilarity = similarityScore / factors;
                        if (avgSimilarity >= similarityThreshold) {
                            similarTests.push(otherTest);
                            processed.add(otherIndex);
                        }
                    }
                });

                // Create group key based on common characteristics
                let groupKey;
                
                // Check for error codes first
                if (errorCodes.httpCodes.length > 0) {
                    groupKey = `HTTP ${errorCodes.httpCodes[0]} Errors`;
                } else if (errorCodes.exceptionTypes.length > 0) {
                    groupKey = errorCodes.exceptionTypes[0];
                } else {
                    // Fall back to pattern extraction
                    groupKey = extractPattern(description);
                }

                if (!groups[groupKey]) {
                    groups[groupKey] = {
                        pattern: groupKey,
                        tests: [],
                        rootCause: null,
                        severity: 'medium'
                    };
                }

                groups[groupKey].tests.push(...similarTests);
            });

            // Detect root causes for each group
            Object.values(groups).forEach(group => {
                group.rootCause = detectRootCause(group.tests);
                
                // Determine severity
                if (group.tests.length > 10) {
                    group.severity = 'critical';
                } else if (group.tests.length > 5) {
                    group.severity = 'high';
                }
            });

            return groups;
        }

        function getSeverityEmoji(severity) {
            return {
                critical: 'üî¥',
                high: 'üü†',
                medium: 'üü°'
            }[severity] || '‚ö™';
        }

        function generateRootCauseAnalysis() {
            if (filteredData.length === 0) return;

            // Group by platform first, then find root causes per platform
            const platformGroups = {};
            
            filteredData.forEach(test => {
                const platform = test.platform || 'Unknown';
                if (!platformGroups[platform]) {
                    platformGroups[platform] = [];
                }
                platformGroups[platform].push(test);
            });

            const allRootCauses = [];

            // Analyze root causes for each platform
            Object.entries(platformGroups).forEach(([platform, tests]) => {
                const groups = advancedGrouping(tests, 0.75);
                const platformRootCauses = Object.values(groups)
                    .filter(g => g.rootCause && g.rootCause.confidence > 0.6)
                    .map(g => ({
                        ...g,
                        platform: platform
                    }))
                    .sort((a, b) => b.tests.length - a.tests.length)
                    .slice(0, 3); // Top 3 per platform

                allRootCauses.push(...platformRootCauses);
            });

            // Sort by impact (test count)
            allRootCauses.sort((a, b) => b.tests.length - a.tests.length);

            if (allRootCauses.length === 0) {
                document.getElementById('rootCauseSection').style.display = 'none';
                return;
            }

            document.getElementById('rootCauseSection').style.display = 'block';

            const container = document.getElementById('rootCauseAnalysis');
            container.innerHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: #edf2f7; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <div style="font-size: 13px; color: #2d3748;">
                        <strong>Platform-Specific Root Cause Analysis:</strong> AI analyzes each platform separately to identify unique issues per platform (Android, iOS, Web).
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    ${allRootCauses.slice(0, 10).map((group, index) => {
                        const rc = group.rootCause;
                        const impact = group.tests.length;
                        const platform = group.platform;
                        const platformInfo = getPlatformInfo(platform);
                        const teams = [...new Set(group.tests.map(t => t.team_name || t.team || 'Unknown'))];
                        
                        return `
                            <div style="background: #f7fafc; border-radius: 8px; padding: 16px; border-left: 4px solid ${
                                rc.confidence > 0.8 ? '#48bb78' : rc.confidence > 0.7 ? '#ed8936' : '#ecc94b'
                            };">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-size: 20px;">${platformInfo.icon}</span>
                                            <span class="platform-badge platform-${platform.toLowerCase()}" style="font-size: 11px;">
                                                ${platform}
                                            </span>
                                        </div>
                                        <div style="font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 4px;">
                                            ${rc.likelyRootCause}
                                        </div>
                                        <div style="font-size: 11px; color: #718096;">
                                            Confidence: ${Math.round(rc.confidence * 100)}%
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="background: #fc8181; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 14px;">
                                            ${impact}
                                        </div>
                                        <div style="font-size: 10px; color: #718096; margin-top: 4px;">
                                            failures
                                        </div>
                                    </div>
                                </div>
                                
                                ${rc.reasoning.length > 0 ? `
                                    <div style="margin-bottom: 12px;">
                                        <div style="font-size: 11px; font-weight: 600; color: #4a5568; margin-bottom: 4px;">
                                            üîç Evidence:
                                        </div>
                                        <ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #718096; line-height: 1.5;">
                                            ${rc.reasoning.slice(0, 2).map(r => `<li style="margin-bottom: 2px;">${r}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                
                                <div style="margin-bottom: 12px;">
                                    <div style="font-size: 11px; font-weight: 600; color: #718096; margin-bottom: 4px;">TEAMS IMPACTED</div>
                                    <div style="font-size: 11px; color: #2d3748;">
                                        ${teams.slice(0, 3).join(', ')}${teams.length > 3 ? ` +${teams.length - 3}` : ''}
                                    </div>
                                </div>
                                
                                ${rc.errorCodes.length > 0 ? `
                                    <div style="margin-bottom: 12px;">
                                        <div style="font-size: 11px; font-weight: 600; color: #718096; margin-bottom: 4px;">ERROR CODES</div>
                                        <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                                            ${rc.errorCodes.map(code => `
                                                <span style="background: #fc8181; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px;">
                                                    HTTP ${code}
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div style="display: flex; gap: 6px; margin-top: 12px;">
                                    <button class="btn" style="padding: 6px 12px; font-size: 11px; flex: 1;" 
                                            onclick="filterByRootCause('${platform}', '${group.pattern.replace(/'/g, "\\'")}', ${impact})">
                                        üîç View ${impact} Tests
                                    </button>
                                    <button class="btn" style="padding: 6px 12px; font-size: 11px; background: #48bb78; flex: 1;" 
                                            onclick="createRootCauseTicket('${platform}', '${rc.likelyRootCause.replace(/'/g, "\\'")}', ${impact})">
                                        üé´ Create Ticket
                                    </button>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function filterByRootCause(platform, pattern, count) {
            console.log('filterByRootCause called:', { platform, pattern, count });
            
            // First filter by platform
            let platformFiltered = testData.filter(test => {
                const testPlatform = test.platform || 'Unknown';
                return testPlatform === platform;
            });
            
            console.log('Platform filtered:', platformFiltered.length, 'tests');
            
            // Then apply advanced grouping to find the specific pattern
            const groups = advancedGrouping(platformFiltered, 0.75);
            console.log('Groups found:', Object.keys(groups));
            
            const group = Object.values(groups).find(g => g.pattern === pattern);
            
            if (group && group.tests.length > 0) {
                console.log('Group found with', group.tests.length, 'tests');
                filteredData = group.tests;
                currentPage = 1;
                
                // Update the platform filter to show selected platform
                const platformFilter = document.getElementById('platformFilter');
                if (platformFilter) {
                    platformFilter.value = platform;
                }
                
                // Regenerate the view
                groupFailures();
                generateInsights();
                
                // Scroll to grouped failures
                const groupedFailuresElement = document.querySelector('#groupedFailures');
                if (groupedFailuresElement) {
                    groupedFailuresElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                showToast(`Filtered to ${group.tests.length} ${platform} tests with root cause: ${pattern}`);
            } else {
                console.error('Group not found for pattern:', pattern);
                alert(`Could not find tests for pattern: ${pattern}`);
            }
        }

        function createRootCauseTicket(platform, rootCause, impact) {
            alert(`Feature: Create ticket for root cause\n\nPlatform: ${platform}\nRoot Cause: ${rootCause}\nImpact: ${impact} test failures\n\nThis would integrate with JIRA/Linear to create a ticket with:\n- Platform-specific root cause analysis\n- Affected tests list\n- Suggested fix priority\n- Team assignments`);
        }

        function generateInsights() {
            const insights = [];

            if (currentView === 'platform') {
                // Platform-specific insights
                const platformFailures = {};
                filteredData.forEach(test => {
                    const platform = test.platform || 'Unknown';
                    if (!platformFailures[platform]) {
                        platformFailures[platform] = { count: 0, patterns: {} };
                    }
                    platformFailures[platform].count++;
                    
                    const pattern = extractPattern(test.failure_description || '');
                    platformFailures[platform].patterns[pattern] = (platformFailures[platform].patterns[pattern] || 0) + 1;
                });

                // Most problematic platform
                const sortedPlatforms = Object.entries(platformFailures).sort((a, b) => b[1].count - a[1].count);
                if (sortedPlatforms.length > 0) {
                    const [topPlatform, data] = sortedPlatforms[0];
                    const topPattern = Object.entries(data.patterns).sort((a, b) => b[1] - a[1])[0];
                    insights.push({
                        title: `${getPlatformInfo(topPlatform).icon} Most Affected Platform`,
                        text: `${topPlatform} has ${data.count} failures (${Math.round(data.count / filteredData.length * 100)}% of all failures). Primary issue: ${topPattern[0]} with ${topPattern[1]} occurrences.`
                    });
                }

                // Platform stability comparison
                if (sortedPlatforms.length > 1) {
                    const stablePlatform = sortedPlatforms[sortedPlatforms.length - 1][0];
                    const unstablePlatform = sortedPlatforms[0][0];
                    insights.push({
                        title: 'Platform Stability Comparison',
                        text: `${unstablePlatform} has ${sortedPlatforms[0][1].count} failures vs ${stablePlatform} with ${sortedPlatforms[sortedPlatforms.length - 1][1].count} failures. Consider focusing stabilization efforts on ${unstablePlatform}.`
                    });
                }

                // Platform-specific patterns
                Object.entries(platformFailures).forEach(([platform, data]) => {
                    const uniquePatterns = Object.keys(data.patterns).length;
                    if (uniquePatterns > 3) {
                        insights.push({
                            title: `${platform} Diversity`,
                            text: `${platform} shows ${uniquePatterns} different failure patterns, suggesting diverse testing scenarios. Top 3: ${Object.entries(data.patterns).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([p, c]) => `${p} (${c})`).join(', ')}.`
                        });
                    }
                });
            } else {
                // Original combined/daily insights
                // Most common failure type
                const failureTypes = {};
                filteredData.forEach(test => {
                    const pattern = extractPattern(test.failure_description || '');
                    failureTypes[pattern] = (failureTypes[pattern] || 0) + 1;
                });
                const topFailure = Object.entries(failureTypes).sort((a, b) => b[1] - a[1])[0];
                if (topFailure) {
                    insights.push({
                        title: 'Most Common Issue',
                        text: `${topFailure[0]} accounts for ${Math.round(topFailure[1] / filteredData.length * 100)}% of all failures. Consider prioritizing fixes for this pattern.`
                    });
                }

                // Platform analysis
                const platformFailures = {};
                filteredData.forEach(test => {
                    const platform = test.platform || 'Unknown';
                    platformFailures[platform] = (platformFailures[platform] || 0) + 1;
                });
                const topPlatform = Object.entries(platformFailures).sort((a, b) => b[1] - a[1])[0];
                if (topPlatform) {
                    insights.push({
                        title: 'Platform Stability',
                        text: `${topPlatform[0]} has the most failures (${topPlatform[1]}). This platform may need additional stabilization efforts.`
                    });
                }

                // Team analysis
                const teamFailures = {};
                filteredData.forEach(test => {
                    const team = test.team_name || test.team || 'Unknown';
                    teamFailures[team] = (teamFailures[team] || 0) + 1;
                });
                const topTeam = Object.entries(teamFailures).sort((a, b) => b[1] - a[1])[0];
                if (topTeam) {
                    insights.push({
                        title: 'Team Impact',
                        text: `${topTeam[0]} is experiencing ${topTeam[1]} test failures. Recommend dedicating sprint time for test stabilization.`
                    });
                }

                // Trend insight
                if (topFailure && topPlatform && topTeam) {
                    insights.push({
                        title: 'Recommended Actions',
                        text: `Based on the analysis: 1) Create unified fix for ${topFailure[0]}, 2) Review ${topPlatform[0]} test environment, 3) Schedule stability sprint for ${topTeam[0]}.`
                    });
                }
            }

            document.getElementById('insights').innerHTML = insights.map(insight => `
                <div class="insight-item">
                    <div class="insight-title">${insight.title}</div>
                    <div class="insight-text">${insight.text}</div>
                </div>
            `).join('');
        }

        function createCharts() {
            // Simple text-based charts for demo
            const trendChart = document.getElementById('trendChart');
            const teamChart = document.getElementById('teamChart');

            // Trend by date
            const dates = {};
            filteredData.forEach(test => {
                const date = test.date || 'Unknown';
                dates[date] = (dates[date] || 0) + 1;
            });

            const sortedDates = Object.entries(dates).sort((a, b) => a[0].localeCompare(b[0])).slice(-7);
            const maxCount = Math.max(...sortedDates.map(d => d[1]));

            trendChart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px; padding: 20px 0;">
                    ${sortedDates.map(([date, count]) => `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #718096;">${date}</span>
                                <span style="font-size: 12px; font-weight: 600; color: #2d3748;">${count}</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 4px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${(count / maxCount) * 100}%;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Team distribution
            const teams = {};
            filteredData.forEach(test => {
                const team = test.team_name || test.team || 'Unknown';
                teams[team] = (teams[team] || 0) + 1;
            });

            const sortedTeams = Object.entries(teams).sort((a, b) => b[1] - a[1]);
            const maxTeamCount = Math.max(...sortedTeams.map(t => t[1]));

            teamChart.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 12px; padding: 20px 0;">
                    ${sortedTeams.map(([team, count]) => `
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 12px; color: #718096;">${team}</span>
                                <span style="font-size: 12px; font-weight: 600; color: #2d3748;">${count}</span>
                            </div>
                            <div style="background: #e2e8f0; height: 20px; border-radius: 4px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); height: 100%; width: ${(count / maxTeamCount) * 100}%;"></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function generateTrendAnalysis() {
            if (filteredData.length === 0) return;

            // Group failures by date to analyze trends
            const dateGroups = {};
            filteredData.forEach(test => {
                const date = test.date || 'Unknown';
                if (!dateGroups[date]) {
                    dateGroups[date] = [];
                }
                dateGroups[date].push(test);
            });

            // Sort dates
            const sortedDates = Object.keys(dateGroups).filter(d => d !== 'Unknown').sort();
            
            if (sortedDates.length < 2) {
                document.getElementById('trendAnalysis').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #718096;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìä</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Not Enough Data</div>
                        <div style="font-size: 14px;">Need at least 2 days of data to analyze trends</div>
                    </div>
                `;
                return;
            }

            // Get root causes and track their trends
            const groups = advancedGrouping(filteredData, 0.75);
            const rootCauseTrends = [];

            Object.values(groups).forEach(group => {
                if (!group.rootCause || group.rootCause.confidence < 0.6) return;

                // Count failures per date for this root cause
                const trendData = {};
                sortedDates.forEach(date => {
                    trendData[date] = 0;
                });

                group.tests.forEach(test => {
                    const date = test.date;
                    if (trendData[date] !== undefined) {
                        trendData[date]++;
                    }
                });

                // Calculate trend (last 7 days vs previous 7 days if available)
                const recentDates = sortedDates.slice(-7);
                const olderDates = sortedDates.slice(-14, -7);

                const recentCount = recentDates.reduce((sum, date) => sum + trendData[date], 0);
                const olderCount = olderDates.length > 0 
                    ? olderDates.reduce((sum, date) => sum + trendData[date], 0)
                    : recentCount;

                let trendDirection = 'stable';
                let trendPercentage = 0;
                
                if (olderCount > 0) {
                    trendPercentage = Math.round(((recentCount - olderCount) / olderCount) * 100);
                    
                    if (trendPercentage > 20) {
                        trendDirection = 'increasing';
                    } else if (trendPercentage < -20) {
                        trendDirection = 'decreasing';
                    } else {
                        trendDirection = 'stable';
                    }
                } else if (recentCount > 0) {
                    trendDirection = 'increasing';
                    trendPercentage = 100;
                }

                // Create sparkline
                const sparklineData = recentDates.map(date => trendData[date]);
                const maxValue = Math.max(...sparklineData, 1);
                const sparkline = generateSparkline(sparklineData, maxValue);

                rootCauseTrends.push({
                    rootCause: group.rootCause.likelyRootCause,
                    pattern: group.pattern,
                    platform: group.platform || 'All',
                    recentCount,
                    olderCount,
                    trendDirection,
                    trendPercentage,
                    sparkline,
                    confidence: group.rootCause.confidence,
                    severity: group.severity
                });
            });

            // Sort by urgency: increasing trends first, then by count
            rootCauseTrends.sort((a, b) => {
                if (a.trendDirection === 'increasing' && b.trendDirection !== 'increasing') return -1;
                if (a.trendDirection !== 'increasing' && b.trendDirection === 'increasing') return 1;
                return b.recentCount - a.recentCount;
            });

            const container = document.getElementById('trendAnalysis');
            container.innerHTML = `
                <div style="margin-bottom: 16px; padding: 12px; background: #edf2f7; border-radius: 8px; border-left: 4px solid #4299e1;">
                    <div style="font-size: 13px; color: #2d3748;">
                        <strong>Trend Analysis:</strong> Comparing last 7 days vs previous 7 days to identify which issues are getting worse, better, or staying the same.
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                    ${rootCauseTrends.slice(0, 10).map(trend => {
                        const urgencyLevel = trend.trendDirection === 'increasing' && trend.trendPercentage > 50 
                            ? 'critical' 
                            : trend.trendDirection === 'increasing' 
                            ? 'high' 
                            : trend.trendDirection === 'decreasing' 
                            ? 'low' 
                            : 'medium';

                        const borderColor = {
                            'critical': '#f56565',
                            'high': '#ed8936',
                            'medium': '#ecc94b',
                            'low': '#48bb78'
                        }[urgencyLevel];

                        const icon = {
                            'increasing': 'üìà',
                            'decreasing': 'üìâ',
                            'stable': '‚û°Ô∏è'
                        }[trend.trendDirection];

                        const statusText = {
                            'increasing': 'INCREASING',
                            'decreasing': 'DECREASING',
                            'stable': 'STABLE'
                        }[trend.trendDirection];

                        const statusColor = {
                            'increasing': '#f56565',
                            'decreasing': '#48bb78',
                            'stable': '#718096'
                        }[trend.trendDirection];

                        const actionText = {
                            'critical': 'üö® URGENT - Fix immediately!',
                            'high': '‚ö†Ô∏è HIGH PRIORITY - Address soon',
                            'medium': 'üìã PLAN FIX - Schedule in sprint',
                            'low': '‚úÖ IMPROVING - Continue monitoring'
                        }[urgencyLevel];

                        return `
                            <div style="background: #f7fafc; border-radius: 8px; padding: 14px; border-left: 4px solid ${borderColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-size: 15px; font-weight: 700; color: #2d3748; margin-bottom: 4px; line-height: 1.3;">
                                            ${trend.rootCause}
                                        </div>
                                        <div style="font-size: 11px; color: #718096;">
                                            ${trend.pattern}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 20px;">
                                            ${icon}
                                        </div>
                                    </div>
                                </div>

                                <div style="margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                                        <div style="flex: 1; height: 30px;">
                                            ${trend.sparkline}
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 13px; font-weight: 700; color: ${statusColor};">
                                                ${statusText}
                                            </div>
                                            <div style="font-size: 11px; color: #718096;">
                                                ${trend.trendPercentage > 0 ? '+' : ''}${trend.trendPercentage}%
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 10px; color: #718096;">
                                        <span>Prev: ${trend.olderCount}</span>
                                        <span>Now: ${trend.recentCount}</span>
                                    </div>
                                </div>

                                <div style="background: ${urgencyLevel === 'critical' || urgencyLevel === 'high' ? '#fff5f5' : urgencyLevel === 'low' ? '#f0fff4' : '#fffaf0'}; 
                                            padding: 8px; border-radius: 6px; margin-bottom: 8px;">
                                    <div style="font-size: 11px; font-weight: 600; color: #2d3748;">
                                        ${actionText}
                                    </div>
                                </div>

                                <button class="btn" style="padding: 6px 12px; font-size: 11px; width: 100%;" 
                                        onclick="filterByPattern('${trend.pattern.replace(/'/g, "\\'")}')">
                                    üîç View All Failures
                                </button>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function generateSparkline(data, maxValue) {
            const width = 100;
            const height = 30;
            const points = data.length;
            const stepX = width / (points - 1);
            
            // Create SVG path
            let path = '';
            data.forEach((value, index) => {
                const x = index * stepX;
                const y = height - (value / maxValue * height);
                
                if (index === 0) {
                    path += `M ${x} ${y}`;
                } else {
                    path += ` L ${x} ${y}`;
                }
            });

            // Determine color based on trend
            const firstHalf = data.slice(0, Math.floor(points / 2)).reduce((a, b) => a + b, 0);
            const secondHalf = data.slice(Math.floor(points / 2)).reduce((a, b) => a + b, 0);
            const color = secondHalf > firstHalf ? '#f56565' : secondHalf < firstHalf ? '#48bb78' : '#718096';

            return `
                <svg width="100%" height="30" viewBox="0 0 ${width} ${height}" style="display: block;">
                    <path d="${path}" stroke="${color}" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    ${data.map((value, index) => {
                        const x = index * stepX;
                        const y = height - (value / maxValue * height);
                        return `<circle cx="${x}" cy="${y}" r="2" fill="${color}"/>`;
                    }).join('')}
                </svg>
            `;
        }

        function filterByPattern(pattern) {
            console.log('filterByPattern called:', pattern);
            
            // Filter to show tests matching this pattern
            const groups = advancedGrouping(testData, 0.75);
            const group = Object.values(groups).find(g => g.pattern === pattern);
            
            if (group && group.tests.length > 0) {
                console.log('Pattern group found with', group.tests.length, 'tests');
                filteredData = group.tests;
                currentPage = 1;
                
                // Regenerate views
                groupFailures();
                generateInsights();
                
                // Scroll to grouped failures
                const groupedFailuresElement = document.querySelector('#groupedFailures');
                if (groupedFailuresElement) {
                    groupedFailuresElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                
                showToast(`Filtered to ${group.tests.length} tests with pattern: ${pattern}`);
            } else {
                console.error('Pattern not found:', pattern);
                alert(`Could not find tests for pattern: ${pattern}`);
            }
        }

        // Demo data for testing - generates 2000+ test records
    </script>
</body>
</html>